---
title: 'Project3: Cartography'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

#Part1: Dollars spent by different countries on HIV or all diseases

```{r message=FALSE, warning=FALSE}

library(readr)
library(tidyverse)
library(dplyr)
library(OpenStreetMap)
library(mapview)
library(mapedit)
library(sf)
library(tidyverse)
library(janitor)
library(ggrepel)
library(rworldmap)
library(osmdata)
library(purrr)
library(transformr)


world <- st_read("data/ne_110m_admin_0_countries.shp") %>% 
  clean_names()

sf::sf_use_s2(FALSE)

spending_2019 <- read_csv("Data/IHME_DAH_DATABASE_1990_2019_Y2020M04D23.CSV") %>%
  filter(year == 2019)


spending_source <- spending_2019 %>%
  select(
    source, contains(c("hiv", "mal", "tb", "ncd"))
  ) 


spending_long_hiv <- spending_source%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd"))) %>%
  mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  select(-name) %>% 
  filter(disease=="hiv") %>% 
  group_by(source) %>% 
  summarize(expenditure_hiv = sum(value, na.rm = TRUE)) %>% 
  mutate(source=str_replace_all(source,"_"," ")) %>% 
  mutate(expenditure_hiv_millions=expenditure_hiv/1e6)

spending_long_alldiseases <- spending_source%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd"))) %>%
  mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  select(-name) %>% 
  group_by(source) %>% 
  summarize(expenditure_alldiseases = sum(value, na.rm = TRUE))%>% 
  mutate(source=str_replace_all(source,"_"," "))%>% 
  mutate(expenditure_alldiseases_millions=expenditure_alldiseases/1e6)

data_Q1_hiv <-world  %>%
  left_join(spending_long_hiv, c("name_long"="source")) %>%
  rename(source=name) 

data_Q1_alldiseases <-world  %>%
  left_join(spending_long_alldiseases, c("name_long"="source")) %>% 
 rename(source=name) 

#  sort_A3,recipientISO code

ggplot() + 
coord_sf()+ 
  geom_sf(data = data_Q1_hiv,
                    aes(fill = expenditure_hiv_millions))+theme_void()+
  labs(title="Expenditure in treating HIV disease by different countries for year 2019",
       caption = "Source: IHME Development Assistance for Health Database") +
  scale_fill_continuous(name =  "Expenditure in millions (USD)")

ggplot() + 
coord_sf()+ 
  geom_sf(data = data_Q1_alldiseases,
                    aes(fill = expenditure_alldiseases_millions))+theme_void()+
  labs(title="Expenditure in treating all diseases by different countries for year 2019",
       caption = "Source: IHME Development Assistance for Health Database")+
  scale_fill_continuous(name =  "Expenditure in millions (USD)")
  
```

#Part2: Dollars received by countries

```{r}
  
spending_2015 <- read_csv("Data/IHME_DAH_DATABASE_1990_2019_Y2020M04D23.CSV") %>%
  filter(year == 2015)


spending_recipient <- spending_2015 %>%
  select(
    recipient_isocode, contains(c("hiv", "mal", "tb", "ncd"))
  )

spending_long_alldiseases_recipient <- spending_recipient%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd")), 
               names_to="name", values_to="value") %>%
  mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  select(-name) %>% 
  group_by(recipient_isocode) %>% 
  summarize(expenditure_alldiseases = sum(value, na.rm = TRUE))%>% 
  mutate(expenditure_alldiseases_millions=expenditure_alldiseases/1e6)

data_Q2_alldiseases <-world  %>%
  left_join(spending_long_alldiseases_recipient, c("iso_a3"="recipient_isocode")) %>% 
  rename(recipient=iso_a3)
  

ggplot() + 
coord_sf()+ 
  geom_sf(data = data_Q2_alldiseases,
                    aes(fill = expenditure_alldiseases_millions))+theme_void()+
  labs(title="Money received by for treating all diseases in 2015",
       caption = "Source: IHME Development Assistance for Health Database") +
  scale_fill_continuous(name =  "Money received in millions (USD)")
  
```

#Part3: Map by gbd region

```{r}

library(rworldmap)

dQ3<-data_Q1_alldiseases %>% 
  group_by(region_wb) %>% 
  summarise(expenditure_alldiseases_millions=sum(expenditure_alldiseases_millions,
                                                 na.rm=T))


ggplot() + 
coord_sf()+ 
  geom_sf(data = dQ3,
                    aes(fill = expenditure_alldiseases_millions))+theme_void()+
  labs(title="Dollars received by GBD regions in treating all diseases for year 2015",
       caption = "Source: IHME Development Assistance for Health Database") 

```

#Part4: Spending by recipient country across time

```{r}
  
spending_recipient_hiv_time<- read_csv("Data/IHME_DAH_DATABASE_1990_2019_Y2020M04D23.CSV") %>% 
  dplyr::select(recipient_country, year,contains(c("hiv", "mal", "tb", "ncd"))) %>% 
  mutate_at(vars(starts_with("hiv")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("mal")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("tb")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("ncd")),funs(as.numeric)) %>%   mutate(recipient_country=str_replace(source, "_"," "))


spending_recipient_all_hiv_time <- spending_recipient_hiv_time%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd")), 
               names_to = "name", values_to = "value") %>%
  #pivot_longer(!recipient_country, names_to = "name", values_to = "value") %>%
  #mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  dplyr::select(-name) %>% 
  filter(value>1000 ) %>% 
  mutate(value_millions=value/1e6) %>% 
  distinct_all() %>% 
  dplyr::select(-value) %>% 
  group_by(recipient_country, year) %>% 
  summarise(expenditure_alldiseases = sum(value_millions, na.rm = TRUE)) %>% 
  ungroup() 


data_Q4_alldiseases_recipient <-world  %>%
  left_join(spending_recipient_all_hiv_time, c("name_long"="recipient_country")) %>% 
  rename(source=name_sort)

ggplot() +
  geom_sf(
    data = world)+
  geom_sf(
    data = data_Q4_alldiseases_recipient,
    mapping = aes(fill = expenditure_alldiseases)
  ) + 
  gganimate::transition_states(year,
                                   transition_length = 1,
                                   state_length = 5)+
  labs(
    title = "Year: {closest_state}",
    subtitle = "Money received by different countries in millions (USD)"
  )+
  rcartocolor::scale_fill_carto_c(palette = "BuGn")+
  guides(fill = guide_legend(title =  "Per Million CHF", 
                             label.position = "bottom",
                             title.position = "top",
                             nrow = 1))+
  theme(legend.position = "bottom")
  
  
```

#Part4 try: Spending by recipient country across time

```{r}

spending_source_hiv_time<- read_csv("Data/IHME_DAH_DATABASE_1990_2019_Y2020M04D23.CSV") %>% 
  dplyr::select(source, year,contains(c("hiv", "mal", "tb", "ncd"))) %>% 
  mutate_at(vars(starts_with("hiv")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("mal")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("tb")),funs(as.numeric)) %>% 
  mutate_at(vars(starts_with("ncd")),funs(as.numeric)) %>% 
  clean_names() %>% 
  mutate(source=str_replace(source, "_"," "))


spending_source_all_hiv_time <- spending_source_hiv_time%>%
  pivot_longer(cols = contains(c("hiv", "mal", "tb", "ncd")), 
               names_to = "name", values_to = "value") %>%
  #pivot_longer(!recipient_country, names_to = "name", values_to = "value") %>%
  #mutate(value = as.numeric(value)) %>% 
  mutate(disease = str_extract(name, "[^_]+")) %>%
  dplyr::select(-name) %>% 
  filter(value>10000) %>% 
  mutate(value_millions=value/1e6) %>% 
  distinct_all() %>% 
  dplyr::select(-value) %>% 
  group_by(source, year) %>% 
  summarise(expenditure_alldiseases = sum(value_millions, na.rm = TRUE)) %>% 
  ungroup() 


data_Q4_alldiseases_source <-world  %>%
  left_join(spending_source_all_hiv_time, c("name_long"="source")) %>% 
  rename(source=name_sort)

ggplot() +
  geom_sf(
    data = world)+
  geom_sf(
    data = data_Q4_alldiseases_source,
    mapping = aes(fill = expenditure_alldiseases)
  ) + 
  gganimate::transition_states(year,
                                   transition_length = 1,
                                   state_length = 5)+
  labs(
    title = "Year: {closest_state}",
    subtitle = "Money spent by different countries (in millions USD)"
  )+
  rcartocolor::scale_fill_carto_c(palette = "BuGn")+
  guides(fill = guide_legend(title =  "Per Million CHF", 
                             label.position = "bottom",
                             title.position = "top",
                             nrow = 1))+
  theme(legend.position = "bottom")
  
  
```

#Part5: Interactive chloropeth map for year 2015

```{r}

tmap_mode("view") # make interactive

tm_shape(dQ3) + 
  tm_polygons(col = "expenditure_alldiseases_millions", 
              style = "quantile", 
              palette = "-viridis")
       
```

#Part6: Spending by one country: Australia for year 2015

```{r}

europe_cropped <- st_crop(world, xmin = -28, xmax = 62, ymin = 35, ymax = 69)

europe_bb <- st_bbox(c(xmin = -28, 
                       xmax = 62, 
                       ymax = 69, 
                       ymin = 35),
        crs = st_crs(4326)) %>% 
  st_as_sfc() %>% 
  st_transform(crs= 'ESRI:54030') %>% 
  st_bbox()

europe_cropped <- europe_cropped %>% 
  mutate(name_sort = case_when(name_sort == "Macedonia, FYR" ~ "North Macedonia",
         name_sort=="Slovak Republic" ~ "Slovakia",
         TRUE ~ as.character(name_sort)))

data_Q6_Europe <-europe_cropped  %>%
  left_join(spending_long_alldiseases_recipient, c("iso_a3"="recipient_isocode"))  

europe <- world %>% 
  filter(continent == "Europe") %>% 
  filter(!sovereignt== "Russia") %>% 
  st_transform(crs = 'ESRI:54030')

  
europe_inset_map <- ggplot() + 
  geom_sf(data = world, 
          fill = "white",
          size = 0.3,
          colour = "lightgrey") + 
  geom_sf(data = europe_cropped, 
          fill = NA, 
          color = "red", 
          size = 0.8) +
  theme_void() +
  coord_sf(xlim = europe_bb[c(1, 3)],
           ylim = europe_bb[c(2, 4)])

europe_inset_map

plot_europe<-ggplot() + 
coord_sf()+ 
  geom_sf(data = data_Q6_Europe,
                    aes(fill = expenditure_alldiseases))+theme_void()+
  labs(title="Dollars received by Europe continent in treating all diseases for year 2015",
       caption = "Source: IHME Development Assistance for Health Database") 

library(patchwork)

layout <- c(
  patchwork::area(t = 1, l = 1, b = 7, r = 9),
  patchwork::area(t = 1, l = 0, b = 6, r = 3)
)


plot_europe + europe_inset_map + 
  plot_layout(design = layout)


europe_map = ggplot() + 
  geom_sf(data = world, colour = "lightgrey",
          fill = "transparent",
          size = 0.5) +
  geom_sf(data = data_Q6_Europe, 
          aes(fill = expenditure_alldiseases_millions),
          alpha = 1,
          color = "lightgrey",
          size = 0.3) +
  theme_void() +
  coord_sf(xlim = st_bbox(europe_bb)[c(1, 3)],
           ylim = st_bbox(europe_bb)[c(2, 4)]) +
  labs(title = "Average per capita yearly income by district, in 2018")+
  guides(fill = guide_legend(title = "", 
                             label.position = "bottom",
                             title.position = "top",
                             nrow = 1))+
  theme(legend.position = "bottom") +
  theme(plot.title = element_text(colour = "darkgrey"))
       
```


#Part7: Plotting  using SITG shapefiles and 3 different layers

```{r}

library(tmap)
library(sf)
library(raster)

sitg<- st_read("data/sitg/CAD_BATIMENT_HORSOL_TOIT_SP.shp") %>% 
  clean_names()

osmbb <-  tmaptools::bb(sitg, ext=1.1)

osmtiles <- tmaptools::read_osm(osmbb, type="esri-topo")

tm_shape(osmtiles) + 
  tm_rgb() +
  tm_shape(sitg) + 
  tm_polygons("altitude_m", 
              style = "quantile", 
              palette = "-viridis",
              alpha = 0.6) +
  tm_layout(frame = FALSE)

# What other layers to plot here????

# tm_shape(sitg)+
#   tm_raster(palette = "Greys", contrast = c(0.1, 0.6))
#   tm_polygons(col = "altitude_m", 
#               style = "quantile", 
#               palette = "-viridis")+
#   tm_shape(lakes) +
#   tm_polygons(col = "lightblue")
```

#Part8: City plot using OpenStreetMap

```{r}


data(countryRegions,envir=environment(),package="rworldmap")

# gbdregions <- countryRegions %>%
#   select(ISO3, ADMIN, GBD) %>%
#   filter(!is.na(GBD))

getbb("zurich") %>% 
  opq()

getbb("zurich") %>% 
    opq() %>%
  add_osm_feature(
    key = "highway",
    value = c(
      "motorway", "primary",
      "secondary", "tertiary"
    )
  )%>%
  osmdata_sf()

# features_glimpse<-getbb("zurich") %>%
#   opq() %>%
#   add_osm_feature(
#     key = "highway",
#     value = c(
#       "motorway", "primary",
#       "secondary", "tertiary"
#     )
#   ) %>%
#   osmdata_sf() %>%
#   purrr::pluck("osm_lines") %>%
#   glimpse()


xc<-getbb("zurich") %>%
  opq() %>%
  add_osm_feature(
    key = "highway",
    value = c(
      "motorway", "primary",
      "secondary", "tertiary"
    )
  ) %>%
  osmdata_sf() %>%
  purrr::pluck("osm_lines") %>%
  #glimpse() %>% 
  pull(highway) %>% 
  summary()
  

getbb("zurich") %>%
  opq() %>%
  add_osm_feature(
    key = "highway",
    value = c(
      "motorway", "primary",
      "secondary", "tertiary"
    )
  ) %>%
  osmdata_sf() %>%
  purrr::pluck("osm_lines") %>%
  ggplot() +
  geom_sf(aes(color = highway))

opq_zurich<-opq(c(8.448006, 47.320220,  8.625441,  47.434666))

lakes <- opq_zurich %>%
  add_osm_feature(key = "natural", value = "water") %>%
  osmdata_sf() %>%
  unname_osmdata_sf() %>%   
  purrr::pluck("osm_multipolygons") 

streets<-opq_zurich %>%
  add_osm_feature(
    key = "highway",
    value = c(
      "motorway", "primary",
      "secondary", "tertiary"
    )
  ) %>%
  osmdata_sf() %>%
  purrr::pluck("osm_lines") 

destination<-opq_zurich %>%
  add_osm_feature(
    key = "destination",
    value = c(
      "Bern", "Chur", "Luzern", "Flughafen"
    )
  ) %>%
  osmdata_sf() %>%
  purrr::pluck("osm_lines") 

small_streets <- opq_zurich %>%
  add_osm_feature(
    key = "highway",
    value = c(
      "residential", "living_street",
      "unclassified",
      "service", "footway"
    )
  ) %>%
  osmdata_sf() %>%
  purrr::pluck("osm_lines")

river <- opq_zurich %>%
add_osm_feature(key = 'waterway', value = 'river') %>%
osmdata_sf() %>%
purrr::pluck('osm_lines')

  ggplot() +
  geom_sf(data = streets, color = "#bdbdbd", size = 1) +
  geom_sf(data = small_streets, color = "#d9d9d9", alpha = 0.6) +
  geom_sf(data = river,  color = "#d0d1e6", size = 1) +
  geom_sf(data = lakes, fill = "blue", color = "blue",alpha = 0.2) +
  theme_void() +
  #geom_sf(data=destination, color = "#bdbdbd", size = 1)+
  coord_sf(
    xlim = c(8.448006, 8.625441),
    ylim = c(47.320220, 47.434666),
    expand = FALSE
  )+
  theme(
    plot.background = element_rect(fill = "#F9F8F5"),
    panel.border = element_blank()
  )


```
